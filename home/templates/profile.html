{% load static %}
{% load profile_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ profile_user.username }}'s Profile - CelestiaTrack</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

<body>
  {% include 'header.html' %}

  <div class="hero">
    <div class="container mt-5">
      <div class="row">
        <!-- Profile Card (Left Column) -->
        <div class="col-md-4 mb-4">
          <div class="card bg-dark text-light border-info">
            <div class="card-body text-center">
              <!-- Profile Picture -->
              {% if is_own_profile %}
              <div style="position: relative; display: inline-block; cursor: pointer;" id="profile-picture-container">
                <img src="{{ profile.get_profile_picture_url }}"
                     alt="{{ profile_user.username }}'s profile picture"
                     class="rounded mb-3"
                     id="profile-picture-img"
                     style="width: 200px; height: 200px; object-fit: cover; border: 3px solid #00d4ff; box-shadow: 0 0 20px #00d4ff; border-radius: 10px; transition: opacity 0.3s;">
                <div class="profile-picture-overlay" style="position: absolute; top: 0; left: 0; width: 200px; height: 200px; background: rgba(0, 0, 0, 0.5); border-radius: 10px; display: none; align-items: center; justify-content: center; color: white; font-size: 14px;">
                  <i class="fas fa-camera"></i> Click to change
                </div>
              </div>
              <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
              {% else %}
              <img src="{{ profile.get_profile_picture_url }}"
                   alt="{{ profile_user.username }}'s profile picture"
                   class="rounded mb-3"
                   style="width: 200px; height: 200px; object-fit: cover; border: 3px solid #00d4ff; box-shadow: 0 0 20px #00d4ff; border-radius: 10px;">
              {% endif %}

              <!-- Username -->
              <h3 class="text-glow">{{ profile_user.username }}</h3>

              <!-- Full Name -->
              {% if profile_user.first_name or profile_user.last_name %}
              <p class="text-light">
                {{ profile_user.first_name }} {{ profile_user.last_name }}
              </p>
              {% endif %}

              <!-- Edit Button (only for own profile) -->
              {% if is_own_profile %}
              <a href="{% url 'profile_edit' %}" class="btn btn-glow mt-3 w-100">
                <i class="fas fa-edit"></i> Edit Profile
              </a>
              {% endif %}
            </div>
          </div>

          <!-- Account Info Card -->
          <div class="card mt-3 bg-dark text-light border-info">
            <div class="card-body">
              <h5 class="card-title text-glow">Account Info</h5>
              <p class="mb-1"><strong>Email:</strong> {{ profile_user.email }}</p>
              {% if profile.location %}
              <p class="mb-1"><strong>Location:</strong> <i class="fas fa-map-marker-alt text-info"></i> {{ profile.location }}</p>
              {% endif %}
              <p class="mb-1"><strong>Joined:</strong> {{ profile_user.date_joined|date:"F d, Y" }}</p>
              <p class="mb-0"><strong>Last Updated:</strong> {{ profile.updated_at|date:"F d, Y" }}</p>
            </div>
          </div>
        </div>

        <!-- Profile Details (Right Column) -->
        <div class="col-md-8">
          <!-- Bio Section -->
          <div class="card mb-3 bg-dark text-light border-info">
            <div class="card-header bg-transparent border-info">
              <h4 class="text-glow">About</h4>
            </div>
            <div class="card-body">
              {% if profile.bio %}
                <p>{{ profile.bio }}</p>
              {% else %}
                <p class="text-muted">
                  {% if is_own_profile %}
                    You haven't added a bio yet. Click "Edit Profile" to add one!
                  {% else %}
                    This user hasn't added a bio yet.
                  {% endif %}
                </p>
              {% endif %}
            </div>
          </div>

          <!-- Favorite Celestial Objects -->
          {% if profile.favorite_celestial_body %}
          <div class="card mb-3 bg-dark text-light border-info">
            <div class="card-header bg-transparent border-info">
              <h4 class="text-glow">Favorite Celestial Objects</h4>
            </div>
            <div class="card-body">
              {% for object in profile.favorite_celestial_body|split:',' %}
                <p class="mb-2">
                  <i class="fas fa-star text-warning"></i> {{ object }}
                </p>
              {% endfor %}
            </div>
          </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>CelestiaTrack - Guided by the light of discovery.</p>
  </footer>

  <!-- Profile Picture Upload Modal -->
  {% if is_own_profile %}
  <div class="modal fade" id="cropImageModal" tabindex="-1" aria-labelledby="cropImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-info">
        <div class="modal-header border-info">
          <h5 class="modal-title text-glow" id="cropImageModalLabel">Crop Profile Picture</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="img-container" style="max-width: 100%; max-height: 500px; overflow: hidden;">
            <img id="imageToCrop" src="" alt="Crop me" style="max-width: 100%;">
          </div>
          <small class="text-muted d-block mt-2">Minimum size: 200x200px. Image will be cropped to square.</small>
        </div>
        <div class="modal-footer border-info">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-glow" id="cropAndUploadBtn">
            <i class="fas fa-check"></i> Crop & Upload
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Cropper.js JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>

  {% if is_own_profile %}
  <script>
    let cropper;
    let cropModal;
    const profilePictureContainer = document.getElementById('profile-picture-container');
    const profilePictureImg = document.getElementById('profile-picture-img');
    const profilePictureInput = document.getElementById('profile-picture-input');
    const imageToCrop = document.getElementById('imageToCrop');
    const cropAndUploadBtn = document.getElementById('cropAndUploadBtn');
    const overlay = document.querySelector('.profile-picture-overlay');

    // Show overlay on hover
    if (profilePictureContainer && overlay) {
      profilePictureContainer.addEventListener('mouseenter', () => {
        overlay.style.display = 'flex';
      });
      profilePictureContainer.addEventListener('mouseleave', () => {
        overlay.style.display = 'none';
      });
    }

    // Open file input when clicking profile picture
    if (profilePictureContainer) {
      profilePictureContainer.addEventListener('click', () => {
        profilePictureInput.click();
      });
    }

    // Handle file selection
    if (profilePictureInput) {
      profilePictureInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file.');
            return;
          }

          // Validate file size (max 10MB)
          if (file.size > 10 * 1024 * 1024) {
            alert('Image size must be less than 10MB.');
            return;
          }

          const reader = new FileReader();
          reader.onload = function(event) {
            imageToCrop.src = event.target.result;
            cropModal = new bootstrap.Modal(document.getElementById('cropImageModal'));
            cropModal.show();
            
            // Initialize cropper after modal is shown
            setTimeout(() => {
              if (cropper) {
                cropper.destroy();
              }
              cropper = new Cropper(imageToCrop, {
                aspectRatio: 1, // Square
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.8,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                minCropBoxWidth: 200,
                minCropBoxHeight: 200,
              });
            }, 300);
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Handle crop and upload
    if (cropAndUploadBtn) {
      cropAndUploadBtn.addEventListener('click', function() {
        if (!cropper) {
          alert('Please wait for the image to load.');
          return;
        }

        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
          width: 400,
          height: 400,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });

        if (!canvas) {
          alert('Error creating cropped image.');
          return;
        }

        // Convert canvas to blob
        canvas.toBlob(function(blob) {
          if (!blob) {
            alert('Error processing image.');
            return;
          }

          // Convert blob to base64
          const reader = new FileReader();
          reader.onload = function() {
            const base64data = reader.result;

            // Show loading state
            cropAndUploadBtn.disabled = true;
            cropAndUploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            // Upload to server
            const formData = new FormData();
            formData.append('cropped_image', base64data);

            // Get CSRF token from cookie
            function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                  }
                }
              }
              return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            fetch('{% url "upload_profile_picture" %}', {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrftoken
              },
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Update profile picture
                profilePictureImg.src = data.image_url + '?t=' + new Date().getTime();
                cropModal.hide();
                
                // Reset file input
                profilePictureInput.value = '';
                
                // Show success message
                alert('Profile picture updated successfully!');
              } else {
                alert('Error: ' + (data.error || 'Failed to upload image.'));
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('An error occurred while uploading the image.');
            })
            .finally(() => {
              cropAndUploadBtn.disabled = false;
              cropAndUploadBtn.innerHTML = '<i class="fas fa-check"></i> Crop & Upload';
            });
          };
          reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.9);
      });
    }

    // Clean up cropper when modal is hidden
    const cropModalElement = document.getElementById('cropImageModal');
    if (cropModalElement) {
      cropModalElement.addEventListener('hidden.bs.modal', function() {
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        imageToCrop.src = '';
        profilePictureInput.value = '';
      });
    }
  </script>
  {% endif %}
</body>
</html>