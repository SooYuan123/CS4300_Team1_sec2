{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Saved Favorites</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body class="bg-dark text-light">

{% include 'header.html' %}

<div class="container py-5">
  <h2 class="text-center mb-5" style="font-family: 'Orbitron', sans-serif;">Favorite Events</h2>
  {% if event_favorites %}
  <div class="list-group mb-5">
    {% for ev in event_favorites %}
      <div class="list-group-item bg-dark text-light border-secondary mb-2">
        <h5>{{ ev.body }} — {{ ev.type }}</h5>
        <ul class="small">
          {% if ev.peak %}<li><strong>Peak:</strong> {{ ev.peak }}</li>{% endif %}
          {% if ev.rise %}<li><strong>Rise:</strong> {{ ev.rise }}</li>{% endif %}
          {% if ev.transit %}<li><strong>Transit:</strong> {{ ev.transit }}</li>{% endif %}
          {% if ev.set %}<li><strong>Set:</strong> {{ ev.set }}</li>{% endif %}
        </ul>
      </div>
    {% endfor %}
    </div>
    {% endif %}
  <h2 class="text-center mb-5" style="font-family: 'Orbitron', sans-serif;">Favorite Images</h2>

  {% if favorites %}
    <div class="row g-4">
      {% for fav in favorites %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <div class="card bg-dark border-light h-100 shadow-sm interactive-img position-relative">
            <!-- Favorite Star (filled since these are saved) -->
            <div class="favorite-star active" data-src="{{ fav.image_url }}">
              <i class="bi bi-star-fill text-warning"></i>
            </div>

            <img src="{{ fav.image_url }}" class="card-img-top" alt="{{ fav.title }}">
            <div class="card-body">
              <h6 class="card-title text-light">{{ fav.title|default:" Image" }}</h6>
              {% if fav.desc %}
                <p class="text-muted small">{{ fav.desc|truncatechars:100 }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center">
      <p class="lead">You haven’t saved any favorite images yet!</p>
      <a href="{% url 'gallery' %}" class="btn btn-outline-light mt-3">Find in Gallery</a>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".favorite-star").forEach(star => {
    star.addEventListener("click", function(e) {
      e.stopPropagation();
      const icon = this.querySelector("i");
      const imageUrl = this.dataset.src;

      fetch("{% url 'toggle_favorite' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ image_url: imageUrl })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.favorited) {
          // Remove card if unfavorited
          this.closest(".col-12").remove();
          if (document.querySelectorAll(".col-12").length === 0) {
            document.querySelector(".container").innerHTML = `
              <div class="text-center">
                <p class="lead">You haven’t saved any favorites yet!</p>
                <a href="{% url 'gallery' %}" class="btn btn-outline-light mt-3">Back to Gallery</a>
              </div>
            `;
          }
        }
      });
    });
  });
});
</script>
</body>
</html>
