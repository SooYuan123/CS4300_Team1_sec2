{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Saved Favorites</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Font Awesome - ADD THIS LINE -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<body class="bg-dark text-light">

{% include 'header.html' %}

<div class="container py-5">
  <h2 class="text-center mb-5" style="font-family: 'Orbitron', sans-serif;">Favorite Events</h2>

  {% if event_favorites %}
  <div class="row g-4">
    {% for ev in event_favorites %}
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card bg-secondary text-light shadow-lg h-100 position-relative favorite-event-card">
  
        <!-- Unfavorite Globe Icon -->
        <div class="position-absolute top-0 end-0 p-2">
          <i class="bi bi-globe-asia-australia text-warning unfavorite-event"
             data-event-id="{{ ev.event_id }}"
             style="font-size: 1.5rem; cursor: pointer;">
          </i>
        </div>
  
        <div class="card-body">
          <h5 class="card-title">{{ ev.body|title }}</h5>
          <h6 class="card-subtitle mb-2 text-warning">{{ ev.type|title }}</h6>
  
          <ul class="list-unstyled mt-3 mb-4">
            {% if ev.peak %}<li><strong>Peak/Transit:</strong> {{ ev.peak|slice:":19" }}</li>{% endif %}
            {% if ev.rise %}<li><strong>Rise:</strong> {{ ev.rise|slice:":19" }}</li>{% endif %}
            {% if ev.transit %}<li><strong>Transit:</strong> {{ ev.transit|slice:":19" }}</li>{% endif %}
            {% if ev.set %}<li><strong>Set:</strong> {{ ev.set|slice:":19" }}</li>{% endif %}
          </ul>
  
          {% if ev.highlights %}
          <details class="mt-3">
            <summary class="text-info">More Details</summary>
            <pre class="bg-dark text-success p-2 rounded mt-2 small">{{ ev.highlights|safe }}</pre>
          </details>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center mb-5">
    <p class="lead">You haven't saved any astronomical events yet!</p>
    <a href="{% url 'events_list' %}" class="btn btn-outline-light mt-3">Find Events</a>
  </div>
  {% endif %}

  <h2 class="text-center mb-5" style="font-family: 'Orbitron', sans-serif;">Favorite Images</h2>

  {% if favorites %}
    <div class="row g-4">
      {% for fav in favorites %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <div class="card bg-dark border-light h-100 shadow-sm interactive-img position-relative">
            <!-- Favorite Star (filled since these are saved) -->
            <div class="favorite-star active" data-src="{{ fav.image_url }}">
              <i class="bi bi-star-fill text-warning"></i>
            </div>

            <img src="{{ fav.image_url }}" class="card-img-top" alt="{{ fav.title }}">
            <div class="card-body">
              <h6 class="card-title text-light">{{ fav.title|default:" Image" }}</h6>
              {% if fav.desc %}
                <p class="text-muted small">{{ fav.desc|truncatechars:100 }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center">
      <p class="lead">You haven’t saved any favorite images yet!</p>
      <a href="{% url 'gallery' %}" class="btn btn-outline-light mt-3">Find in Gallery</a>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".favorite-star").forEach(star => {
    star.addEventListener("click", function(e) {
      e.stopPropagation();
      const icon = this.querySelector("i");
      const imageUrl = this.dataset.src;

      fetch("{% url 'toggle_favorite' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({ image_url: imageUrl })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.favorited) {
          // Remove card if unfavorited
          this.closest(".col-12").remove();
          if (document.querySelectorAll(".col-12").length === 0) {
            document.querySelector(".container").innerHTML = `
              <div class="text-center">
                <p class="lead">You haven’t saved any favorites yet!</p>
                <a href="{% url 'gallery' %}" class="btn btn-outline-light mt-3">Back to Gallery</a>
              </div>
            `;
          }
        }
      });
    });
  });
});
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".unfavorite-event").forEach(icon => {
      icon.addEventListener("click", function(e) {
        e.stopPropagation();
  
        const eventId = this.dataset.eventId;
        const card = this.closest(".col-12");
  
        console.log("Attempting to unfavorite event:", eventId);
  
        fetch("{% url 'toggle_event_favorite' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({
            event_id: eventId
          })
        })
        .then(res => {
          console.log("Server responded with:", res.status);
          return res.json();
        })
        .then(data => {
          console.log("Server JSON:", data);
  
          if (!data.favorited) {
            console.log("Event removed successfully, removing card...");
            card.remove();
  
            if (document.querySelectorAll(".favorite-event-card").length === 0) {
              const container = document.querySelector(".container");
              container.insertAdjacentHTML("afterbegin", `
                <div class="text-center mb-5">
                  <p class="lead">You haven't saved any astronomical events yet!</p>
                  <a href="{% url 'events_list' %}" class="btn btn-outline-light mt-3">View Events</a>
                </div>
              `);
            }
          }
        })
        .catch(err => {
          console.error("Unfavorite event error:", err);
        });
      });
    });
  });
  </script>  
  
</body>
</html>
