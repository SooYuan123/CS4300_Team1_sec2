{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Astronomical Events</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

{% include 'header.html' %}
<body class="bg-dark text-light">
  <div class="container my-5">
    <h2 class="text-center mb-5" style="font-family: 'Orbitron', sans-serif;">
      Astronomical Events & Data
    </h2>

    <!-- Celestial Bodies Section -->
    <div class="mb-5">
      <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
        <i class="bi bi-stars"></i> Celestial Body Positions
      </h3>

      <p class="text-center text-muted mb-4">
        <i class="bi bi-geo-alt"></i> Visibility times for {{ location }}
      </p>

      <div id="celestial-container" class="row g-3 text-center">

        <!-- Loading wrapper -->
        <div id="celestial-loading" 
             class="d-flex flex-column align-items-center justify-content-center"
             style="min-height: 200px; width: 100%;">
          <div class="spinner-border text-primary"></div>
          <p class="mt-2" style="color: #f5e8a3;">Loading celestial bodies...</p>
        </div>
      
      </div>

    <hr class="my-5 border-secondary">

    <!-- Astronomical Events Section -->
    <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
      <i class="bi bi-calendar-event"></i> Sun & Moon Rise/Set Times
    </h3>

    <p class="text-center mb-4" style="color: #f5e8a3;">
      <i class="bi bi-info-circle"></i> Powered by Radiant Drift API
    </p>

    <div id="celestial-container" class="row g-3 text-center">
    
    </div>
    <!-- Events Container -->
    <div class="row g-4" id="events-container">
      <!-- Initially empty; filled asynchronously -->
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center my-4" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2" style="color: #f5e8a3;">Loading more events...</p>
    </div>

    <!-- End of Events Message -->
    <div id="end-message" class="alert alert-info text-center" style="display: none;">
      <i class="bi bi-check-circle"></i> All events loaded
    </div>

    <!-- Error Message -->
    <div id="error-message" class="alert alert-danger text-center" style="display: none;">
      <i class="bi bi-exclamation-triangle"></i> <span id="error-text">Failed to load events</span>
      <button class="btn btn-outline-danger btn-sm ms-2" onclick="retryLoad()">Retry</button>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ===========================================
       ASYNC LOADING LOGIC FOR CELESTIAL
       ============================================ -->
  <script>
    // --------------------------
    // Render helpers
    // --------------------------

    function renderBodyCard(body) {
      return `
        <div class="col-12 col-md-6 col-lg-4 col-xl-3">
          <div class="card bg-dark border-primary text-light shadow h-100">
            <div class="card-body">
              <h5 class="card-title text-primary">
                <i class="bi bi-circle-fill"></i> ${body.name}
              </h5>

              ${body.nextVisibleStr ? `
                <div class="alert alert-info py-2 mb-3">
                  <small><strong>Next Visible:</strong><br>
                  ${body.nextVisibleStr.slice(0, 10)} ${body.nextVisibleStr.slice(11, 16)} UTC</small>
                </div>
              ` : `
                <div class="alert alert-secondary py-2 mb-3">
                  <small>Visibility data unavailable.</small>
                </div>
              `}

              <details class="mt-2">
                <summary class="text-warning" style="cursor: pointer;">Physical Properties</summary>
                <ul class="list-unstyled mt-2 small">
                  ${body.meanRadius ? `<li><strong>Radius:</strong> ${body.meanRadius.toFixed(0)} km</li>` : ""}
                  ${body.mass?.massValue ? `<li><strong>Mass:</strong> ${body.mass.massValue} × 10^${body.mass.massExponent} kg</li>` : ""}
                  ${body.density ? `<li><strong>Density:</strong> ${body.density.toFixed(2)} g/cm³</li>` : ""}
                  ${body.gravity ? `<li><strong>Gravity:</strong> ${body.gravity.toFixed(2)} m/s²</li>` : ""}
                  ${body.avgTemp ? `<li><strong>Avg Temp:</strong> ${body.avgTemp} K</li>` : ""}
                </ul>
              </details>

              ${body.moons && body.moons.length ? `
                <details class="mt-2">
                  <summary class="text-info" style="cursor: pointer;">
                    Moons (${body.moons.length})
                  </summary>
                  <div class="mt-2 small" style="max-height: 100px; overflow-y: auto;">
                    ${body.moons.map(m => `
                      <span class="badge bg-secondary me-1 mb-1">${m.moon || m.englishName || m.name}</span>
                    `).join("")}
                  </div>
                </details>
              ` : ""}
            </div>
          </div>
        </div>
      `;
    }


    // -----------------------------
    // Fetch & render async sections
    // -----------------------------
    document.addEventListener("DOMContentLoaded", () => {
      // Celestial Bodies
      fetch("/api/celestial/")
        .then(r => r.json())
        .then(data => {
          const el = document.getElementById("celestial-container");
          el.innerHTML = "";
          data.bodies.forEach(body => {
            el.insertAdjacentHTML("beforeend", renderBodyCard(body));
          });
        });

      // Load initial events (infinite scroll)
      loadMoreEvents();
    });
  </script>

  <script>
    // Infinite scroll implementation
    let currentOffset = {{ events|length }};
    let isLoading = false;
    let hasMore = {{ has_more|yesno:"true,false" }};
    let retryCount = 0;
    const maxRetries = 3;

    function createEventCard(event) {
      const peak = event.peak ? event.peak.slice(0, 19) : 'N/A';
      const rise = event.rise ? event.rise.slice(0, 19) : 'N/A';
      const transit = event.transit ? event.transit.slice(0, 19) : 'N/A';
      const set = event.set ? event.set.slice(0, 19) : 'N/A';
      
      return `
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card bg-secondary text-light shadow-lg h-100">
            <div class="card-body">
              <h5 class="card-title">${event.body.charAt(0).toUpperCase() + event.body.slice(1)}</h5>
              <h6 class="card-subtitle mb-2 text-warning">${event.type ? event.type.charAt(0).toUpperCase() + event.type.slice(1) : 'Rise-Set'}</h6>
              <ul class="list-unstyled mt-3 mb-4">
                ${event.peak ? `<li><strong>Peak/Transit:</strong> ${peak}</li>` : ''}
                ${event.rise ? `<li><strong>Rise:</strong> ${rise}</li>` : ''}
                ${event.transit ? `<li><strong>Transit:</strong> ${transit}</li>` : ''}
                ${event.set ? `<li><strong>Set:</strong> ${set}</li>` : ''}
                ${event.obscuration ? `<li><strong>Obscuration:</strong> ${event.obscuration}</li>` : ''}
              </ul>
              <details class="mt-3">
                <summary class="text-info">More Details</summary>
                <pre class="bg-dark text-success p-2 rounded mt-2 small">${JSON.stringify(event.highlights, null, 2)}</pre>
              </details>
            </div>
          </div>
        </div>
      `;
    }

    function showLoading() {
      document.getElementById('loading-spinner').style.display = 'block';
      document.getElementById('end-message').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading-spinner').style.display = 'none';
    }

    function showEndMessage() {
      document.getElementById('end-message').style.display = 'block';
      hideLoading();
    }

    function showError(message) {
      document.getElementById('error-text').textContent = message;
      document.getElementById('error-message').style.display = 'block';
      hideLoading();
    }

    function loadMoreEvents() {
      if (isLoading || !hasMore) return;

      isLoading = true;
      showLoading();

      fetch(`/api/events/?offset=${currentOffset}&limit=20`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.events && data.events.length > 0) {
            const container = document.getElementById('events-container');
            data.events.forEach(event => {
              container.insertAdjacentHTML('beforeend', createEventCard(event));
            });
            currentOffset += data.events.length;
            hasMore = data.has_more;
            
            if (!hasMore) {
              showEndMessage();
            }
          } else {
            hasMore = false;
            showEndMessage();
          }
          retryCount = 0; // Reset retry count on success
        })
        .catch(error => {
          console.error('Error loading events:', error);
          if (retryCount < maxRetries) {
            retryCount++;
            setTimeout(() => {
              loadMoreEvents();
            }, 1000 * retryCount); // Exponential backoff
          } else {
            showError(`Failed to load events: ${error.message}`);
          }
        })
        .finally(() => {
          isLoading = false;
        });
    }

    function retryLoad() {
      retryCount = 0;
      loadMoreEvents();
    }

    // Debounced scroll handler
    let scrollTimeout;
    function handleScroll() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // Load more when user is 200px from bottom
        if (scrollTop + windowHeight >= documentHeight - 200) {
          loadMoreEvents();
        }
      }, 100);
    }

    // Initialize scroll listener
    window.addEventListener('scroll', handleScroll);

    // Load more events on page load if needed
    document.addEventListener('DOMContentLoaded', function() {
      if (hasMore && currentOffset < 20) {
        // If we have more events and haven't loaded the initial batch yet
        loadMoreEvents();
      }
    });
  </script>
  
</body>
</html>