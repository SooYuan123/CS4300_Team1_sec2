{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Astronomical Events</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Font Awesome - ADD THIS LINE -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

{% include 'header.html' %}
<body class="bg-dark text-light">
  <div class="container my-5">
    <h2 class="text-center mb-5" style="font-family: 'Orbitron', sans-serif;">
      Astronomical Events & Data
    </h2>

    <!-- Moon Phase Section -->
    {% if moon_phase %}
    <div class="mb-5">
      <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
        <i class="bi bi-moon-stars"></i> Current Moon Phase
      </h3>
      <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
          <div class="card bg-dark border-warning text-light shadow">
            <div class="card-body text-center">
              <h4 class="text-warning mb-3">Moon Status</h4>
              {% if moon_phase.illumination %}
              <p class="mb-2"><strong>Illumination:</strong> {{ moon_phase.illumination|floatformat:1 }}%</p>
              {% endif %}
              {% if moon_phase.phase %}
              <p class="mb-2"><strong>Phase:</strong> {{ moon_phase.phase }}</p>
              {% endif %}
              {% if moon_phase.age %}
              <p class="mb-0"><strong>Age:</strong> {{ moon_phase.age|floatformat:1 }} days</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr class="my-5 border-secondary">
    {% endif %}


    <!-- Solar Eclipses Section -->
    {% if solar_eclipses %}
    <div class="mb-5">
      <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
        <i class="bi bi-brightness-high"></i> Upcoming Solar Eclipses
      </h3>
      <div class="row g-3">
        {% for eclipse in solar_eclipses %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card bg-dark border-danger text-light shadow">
            <div class="card-body">
              <h5 class="card-title text-danger">
                <i class="bi bi-exclamation-triangle"></i> Solar Eclipse
              </h5>
              <ul class="list-unstyled mt-3">
                {% if eclipse.date %}
                <li><strong>Date:</strong> {{ eclipse.date }}</li>
                {% endif %}
                {% if eclipse.type %}
                <li><strong>Type:</strong> {{ eclipse.type }}</li>
                {% endif %}
                {% if eclipse.magnitude %}
                <li><strong>Magnitude:</strong> {{ eclipse.magnitude }}</li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <hr class="my-5 border-secondary">
    {% endif %}

    <!-- Celestial Bodies Section -->
    {% if celestial_bodies %}
    <div class="mb-5">
      <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
        <i class="bi bi-stars"></i> Celestial Body Positions
      </h3>
      <p class="text-center text-muted mb-4">
        <i class="bi bi-geo-alt"></i> Visibility times for {{ location }}
      </p>
      <p class="text-center text-warning mb-4">
        <i class="bi bi-info-circle"></i> Visibility data powered by Radiant Drift API (Sun & Moon only)
      </p>
      
      <div class="row g-3">
        {% for body in celestial_bodies %}
        <div class="col-12 col-md-6 col-lg-4 col-xl-3">
          <div class="card bg-dark border-primary text-light shadow h-100">
            <div class="card-body">
              <h5 class="card-title text-primary">
                <i class="bi bi-circle-fill"></i> {{ body.name }}
              </h5>
              
              {% if body.nextVisibleStr %}
              <div class="alert alert-info py-2 mb-3">
                <small><strong>Next Visible:</strong><br>
                {{ body.nextVisibleStr|slice:":10" }} {{ body.nextVisibleStr|slice:"11:16" }} UTC</small>
              </div>
              {% else %}
              <div class="alert alert-secondary py-2 mb-3">
                <small>
                  {% if body.name == "Sun" or body.name == "Moon" %}
                  Calculating visibility...
                  {% else %}
                  Visibility data unavailable for planets
                  {% endif %}
                </small>
              </div>
              {% endif %}

              <details class="mt-2">
                <summary class="text-warning" style="cursor: pointer;">Physical Properties</summary>
                <ul class="list-unstyled mt-2 small">
                  {% if body.meanRadius %}
                  <li><strong>Radius:</strong> {{ body.meanRadius|floatformat:0 }} km</li>
                  {% endif %}
                  {% if body.mass.massValue %}
                  <li><strong>Mass:</strong> {{ body.mass.massValue|floatformat:2 }} × 10^{{ body.mass.massExponent }} kg</li>
                  {% endif %}
                  {% if body.density %}
                  <li><strong>Density:</strong> {{ body.density|floatformat:2 }} g/cm³</li>
                  {% endif %}
                  {% if body.gravity %}
                  <li><strong>Gravity:</strong> {{ body.gravity|floatformat:2 }} m/s²</li>
                  {% endif %}
                  {% if body.avgTemp %}
                  <li><strong>Avg Temp:</strong> {{ body.avgTemp|floatformat:0 }} K</li>
                  {% endif %}
                </ul>
              </details>

              {% if body.moons %}
              <details class="mt-2">
                <summary class="text-info" style="cursor: pointer;">Moons ({{ body.moons|length }})</summary>
                <div class="mt-2 small" style="max-height: 100px; overflow-y: auto;">
                  {% for moon in body.moons %}
                  <span class="badge bg-secondary me-1 mb-1">{{ moon.moon }}</span>
                  {% endfor %}
                </div>
              </details>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <hr class="my-5 border-secondary">
    {% endif %}

    <!-- Astronomical Events Section -->
    <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
      <i class="bi bi-calendar-event"></i> Sun & Moon Rise/Set Times
    </h3>
    <p class="text-center text-muted mb-4">
      <i class="bi bi-info-circle"></i> Powered by Radiant Drift API
    </p>
    
    {% if events %}
      <div class="row g-4" id="events-container">
        {% for e in events %}
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card bg-secondary text-light shadow-lg h-100">
              <div class="card-body">
                <h5 class="card-title">{{ e.body|title }}</h5>
                <h6 class="card-subtitle mb-2 text-warning">{{ e.type|title }}</h6>
                <ul class="list-unstyled mt-3 mb-4">
                  {% if e.peak %}
                  <li><strong>Peak/Transit:</strong> {{ e.peak|slice:":19" }}</li>
                  {% endif %}
                  {% if e.rise %}
                  <li><strong>Rise:</strong> {{ e.rise|slice:":19" }}</li>
                  {% endif %}
                  {% if e.transit %}
                  <li><strong>Transit:</strong> {{ e.transit|slice:":19" }}</li>
                  {% endif %}
                  {% if e.set %}
                  <li><strong>Set:</strong> {{ e.set|slice:":19" }}</li>
                  {% endif %}
                  {% if e.obscuration %}
                    <li><strong>Obscuration:</strong> {{ e.obscuration }}</li>
                  {% endif %}
                </ul>

                <details class="mt-3">
                  <summary class="text-info">More Details</summary>
                  <pre class="bg-dark text-success p-2 rounded mt-2 small">{{ e.highlights|safe }}</pre>
                </details>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Loading Spinner -->
      <div id="loading-spinner" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading more events...</p>
      </div>

      <!-- End of Events Message -->
      <div id="end-message" class="alert alert-info text-center" style="display: none;">
        <i class="bi bi-check-circle"></i> All events loaded
      </div>

      <!-- Error Message -->
      <div id="error-message" class="alert alert-danger text-center" style="display: none;">
        <i class="bi bi-exclamation-triangle"></i> <span id="error-text">Failed to load events</span>
        <button class="btn btn-outline-danger btn-sm ms-2" onclick="retryLoad()">Retry</button>
      </div>
    {% else %}
      <div class="alert alert-warning text-center">
        No upcoming events found.
      </div>
    {% endif %}

    {% if weather_forecast %}
    <hr class="my-5 border-info" style="opacity: 0.3;">

    <div class="mb-5 pb-5">
      <h1 class="text-center mb-5 text-glow" style="font-family: 'Orbitron', sans-serif; font-size: 3.5rem;">
        <i class="bi bi-cloud-sun"></i> Weather Forecast
      </h1>

      <div class="card bg-dark border-info shadow-lg">
        <div class="card-header bg-transparent border-info p-3">
            <h4 class="text-info mb-0 text-center">Viewing Conditions (Next 12 Hours)</h4>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-dark table-hover text-center mb-0 align-middle">
              <thead>
                <tr class="text-info" style="font-size: 1.2rem;">
                  <th class="py-4">Time</th>
                  <th class="py-4">Cloud Cover</th>
                  <th class="py-4">Visibility</th>
                  <th class="py-4">Precipitation</th>
                  <th class="py-4">Status</th>
                </tr>
              </thead>
              <tbody>
                {% for hour in weather_forecast %}
                  <tr>
                      <td class="fs-5">{{ hour.time|slice:"11:16" }}</td>

                      <td style="min-width: 150px;">
                          <div class="d-flex align-items-center justify-content-center">
                            <span class="me-2" style="width: 40px;">{{ hour.cloud_cover }}%</span>
                            <div class="progress flex-grow-1" style="height: 10px; background-color: rgba(255,255,255,0.1);">
                              {% if hour.cloud_cover < 20 %}
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ hour.cloud_cover }}%"></div>
                              {% elif hour.cloud_cover < 50 %}
                                <div class="progress-bar bg-warning" role="progressbar" style="width: {{ hour.cloud_cover }}%"></div>
                              {% else %}
                                <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ hour.cloud_cover }}%"></div>
                              {% endif %}
                            </div>
                          </div>
                      </td>

                      <td class="text-light">
                        <span class="badge bg-transparent border border-light">{{ hour.visibility|floatformat:0 }} m</span>
                      </td>

                      <td>
                          {% if hour.precipitation_probability > 0 %}
                             <span class="text-info fw-bold"><i class="bi bi-droplet-fill"></i> {{ hour.precipitation_probability }}%</span>
                          {% else %}
                             <span class="text-light"><i class="bi bi-droplet"></i> 0%</span>
                          {% endif %}
                      </td>

                      <td>
                          {% if hour.cloud_cover < 20 %}
                            <div class="text-success">
                                <i class="bi bi-stars" style="font-size: 1.3rem;"></i>
                                <span class="fw-bold ms-2">Great</span>
                            </div>
                          {% elif hour.cloud_cover < 60 %}
                            <div class="text-warning">
                                <i class="bi bi-cloud-moon" style="font-size: 1.3rem;"></i>
                                <span class="fw-bold ms-2">Fair</span>
                            </div>
                          {% else %}
                            <div class="text-danger">
                                <i class="bi bi-clouds" style="font-size: 1.3rem;"></i>
                                <span class="fw-bold ms-2">Poor</span>
                            </div>
                          {% endif %}
                      </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Infinite scroll implementation
    let currentOffset = {{ events|length }};
    let isLoading = false;
    let hasMore = {{ has_more|yesno:"true,false" }};
    let retryCount = 0;
    const maxRetries = 3;

    function createEventCard(event) {
      const peak = event.peak ? event.peak.slice(0, 19) : 'N/A';
      const rise = event.rise ? event.rise.slice(0, 19) : 'N/A';
      const transit = event.transit ? event.transit.slice(0, 19) : 'N/A';
      const set = event.set ? event.set.slice(0, 19) : 'N/A';
      
      return `
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card bg-secondary text-light shadow-lg h-100">
            <div class="card-body">
              <h5 class="card-title">${event.body.charAt(0).toUpperCase() + event.body.slice(1)}</h5>
              <h6 class="card-subtitle mb-2 text-warning">${event.type ? event.type.charAt(0).toUpperCase() + event.type.slice(1) : 'Rise-Set'}</h6>
              <ul class="list-unstyled mt-3 mb-4">
                ${event.peak ? `<li><strong>Peak/Transit:</strong> ${peak}</li>` : ''}
                ${event.rise ? `<li><strong>Rise:</strong> ${rise}</li>` : ''}
                ${event.transit ? `<li><strong>Transit:</strong> ${transit}</li>` : ''}
                ${event.set ? `<li><strong>Set:</strong> ${set}</li>` : ''}
                ${event.obscuration ? `<li><strong>Obscuration:</strong> ${event.obscuration}</li>` : ''}
              </ul>
              <details class="mt-3">
                <summary class="text-info">More Details</summary>
                <pre class="bg-dark text-success p-2 rounded mt-2 small">${JSON.stringify(event.highlights, null, 2)}</pre>
              </details>
            </div>
          </div>
        </div>
      `;
    }

    function showLoading() {
      document.getElementById('loading-spinner').style.display = 'block';
      document.getElementById('end-message').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading-spinner').style.display = 'none';
    }

    function showEndMessage() {
      document.getElementById('end-message').style.display = 'block';
      hideLoading();
    }

    function showError(message) {
      document.getElementById('error-text').textContent = message;
      document.getElementById('error-message').style.display = 'block';
      hideLoading();
    }

    function loadMoreEvents() {
      if (isLoading || !hasMore) return;

      isLoading = true;
      showLoading();

      fetch(`/api/events/?offset=${currentOffset}&limit=20`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.events && data.events.length > 0) {
            const container = document.getElementById('events-container');
            data.events.forEach(event => {
              container.insertAdjacentHTML('beforeend', createEventCard(event));
            });
            currentOffset += data.events.length;
            hasMore = data.has_more;
            
            if (!hasMore) {
              showEndMessage();
            }
          } else {
            hasMore = false;
            showEndMessage();
          }
          retryCount = 0; // Reset retry count on success
        })
        .catch(error => {
          console.error('Error loading events:', error);
          if (retryCount < maxRetries) {
            retryCount++;
            setTimeout(() => {
              loadMoreEvents();
            }, 1000 * retryCount); // Exponential backoff
          } else {
            showError(`Failed to load events: ${error.message}`);
          }
        })
        .finally(() => {
          isLoading = false;
        });
    }

    function retryLoad() {
      retryCount = 0;
      loadMoreEvents();
    }

    // Debounced scroll handler
    let scrollTimeout;
    function handleScroll() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // Load more when user is 200px from bottom
        if (scrollTop + windowHeight >= documentHeight - 200) {
          loadMoreEvents();
        }
      }, 100);
    }

    // Initialize scroll listener
    window.addEventListener('scroll', handleScroll);

    // Load more events on page load if needed
    document.addEventListener('DOMContentLoaded', function() {
      if (hasMore && currentOffset < 20) {
        // If we have more events and haven't loaded the initial batch yet
        loadMoreEvents();
      }
    });
  </script>
</body>
</html>