{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Astronomical Events</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

{% include 'header.html' %}
<body class="bg-dark text-light">
  <div class="container my-5">
    <h2 class="text-center mb-5" style="font-family: 'Orbitron', sans-serif;">
      Astronomical Events & Data
    </h2>

    <!-- Moon Phase Section -->
    {% if moon_phase %}
    <div class="mb-5">
      <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
        <i class="bi bi-moon-stars"></i> Current Moon Phase
      </h3>
      <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
          <div class="card bg-dark border-warning text-light shadow">
            <div class="card-body text-center">
              <h4 class="text-warning mb-3">Moon Status</h4>
              {% if moon_phase.illumination %}
              <p class="mb-2"><strong>Illumination:</strong> {{ moon_phase.illumination|floatformat:1 }}%</p>
              {% endif %}
              {% if moon_phase.phase %}
              <p class="mb-2"><strong>Phase:</strong> {{ moon_phase.phase }}</p>
              {% endif %}
              {% if moon_phase.age %}
              <p class="mb-0"><strong>Age:</strong> {{ moon_phase.age|floatformat:1 }} days</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr class="my-5 border-secondary">
    {% endif %}

    <!-- Solar Eclipses Section -->
    {% if solar_eclipses %}
    <div class="mb-5">
      <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
        <i class="bi bi-brightness-high"></i> Upcoming Solar Eclipses
      </h3>
      <div class="row g-3">
        {% for eclipse in solar_eclipses %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card bg-dark border-danger text-light shadow">
            <div class="card-body">
              <h5 class="card-title text-danger">
                <i class="bi bi-exclamation-triangle"></i> Solar Eclipse
              </h5>
              <ul class="list-unstyled mt-3">
                {% if eclipse.date %}
                <li><strong>Date:</strong> {{ eclipse.date }}</li>
                {% endif %}
                {% if eclipse.type %}
                <li><strong>Type:</strong> {{ eclipse.type }}</li>
                {% endif %}
                {% if eclipse.magnitude %}
                <li><strong>Magnitude:</strong> {{ eclipse.magnitude }}</li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <hr class="my-5 border-secondary">
    {% endif %}

    <!-- Celestial Bodies Section -->
    {% if celestial_bodies %}
    <div class="mb-5">
      <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
        <i class="bi bi-stars"></i> Celestial Body Positions
      </h3>
      <p class="text-center text-muted mb-4">
        <i class="bi bi-geo-alt"></i> Visibility times for {{ location }}
      </p>
      <p class="text-center text-warning mb-4">
        <i class="bi bi-info-circle"></i> Visibility data powered by Radiant Drift API (Sun & Moon only)
      </p>
      
      <div class="row g-3">
        {% for body in celestial_bodies %}
        <div class="col-12 col-md-6 col-lg-4 col-xl-3">
          <div class="card bg-dark border-primary text-light shadow h-100">
            <div class="card-body">
              <h5 class="card-title text-primary">
                <i class="bi bi-circle-fill"></i> {{ body.name }}
              </h5>
              
              {% if body.nextVisibleStr %}
              <div class="alert alert-info py-2 mb-3">
                <small><strong>Next Visible:</strong><br>
                {{ body.nextVisibleStr|slice:":10" }} {{ body.nextVisibleStr|slice:"11:16" }} UTC</small>
              </div>
              {% else %}
              <div class="alert alert-secondary py-2 mb-3">
                <small>
                  {% if body.name == "Sun" or body.name == "Moon" %}
                  Calculating visibility...
                  {% else %}
                  Visibility data unavailable for planets
                  {% endif %}
                </small>
              </div>
              {% endif %}

              <details class="mt-2">
                <summary class="text-warning" style="cursor: pointer;">Physical Properties</summary>
                <ul class="list-unstyled mt-2 small">
                  {% if body.meanRadius %}
                  <li><strong>Radius:</strong> {{ body.meanRadius|floatformat:0 }} km</li>
                  {% endif %}
                  {% if body.mass.massValue %}
                  <li><strong>Mass:</strong> {{ body.mass.massValue|floatformat:2 }} × 10^{{ body.mass.massExponent }} kg</li>
                  {% endif %}
                  {% if body.density %}
                  <li><strong>Density:</strong> {{ body.density|floatformat:2 }} g/cm³</li>
                  {% endif %}
                  {% if body.gravity %}
                  <li><strong>Gravity:</strong> {{ body.gravity|floatformat:2 }} m/s²</li>
                  {% endif %}
                  {% if body.avgTemp %}
                  <li><strong>Avg Temp:</strong> {{ body.avgTemp|floatformat:0 }} K</li>
                  {% endif %}
                </ul>
              </details>

              {% if body.moons %}
              <details class="mt-2">
                <summary class="text-info" style="cursor: pointer;">Moons ({{ body.moons|length }})</summary>
                <div class="mt-2 small" style="max-height: 100px; overflow-y: auto;">
                  {% for moon in body.moons %}
                  <span class="badge bg-secondary me-1 mb-1">{{ moon.moon }}</span>
                  {% endfor %}
                </div>
              </details>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <hr class="my-5 border-secondary">
    {% endif %}

    <!-- Astronomical Events Section -->
    <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
      <i class="bi bi-calendar-event"></i> Sun & Moon Rise/Set Times
    </h3>
    <p class="text-center text-muted mb-4">
      <i class="bi bi-info-circle"></i> Powered by Radiant Drift API
    </p>
    
    {% if events %}
      <div class="row g-4" id="events-container">
        {% for e in events %}
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card bg-secondary text-light shadow-lg h-100">
              <div class="position-absolute top-0 end-0 p-2">
                <i class="bi bi-globe-asia-australia favorite-event-toggle"
                   data-event-id="{{ e.body }}_{{ e.type }}_{{ e.peak }}"
                   data-body="{{ e.body }}"
                   data-type="{{ e.type }}"
                   data-peak="{{ e.peak }}"
                   data-rise="{{ e.rise }}"
                   data-transit="{{ e.transit }}"
                   data-set="{{ e.set }}"
                   style="font-size: 1.5rem; cursor: pointer; color: #0dcaf0;"></i>
              </div>              
              <div class="card-body">
                <h5 class="card-title">{{ e.body|title }}</h5>
                <h6 class="card-subtitle mb-2 text-warning">{{ e.type|title }}</h6>
                <ul class="list-unstyled mt-3 mb-4">
                  {% if e.peak %}
                  <li><strong>Peak/Transit:</strong> {{ e.peak|slice:":19" }}</li>
                  {% endif %}
                  {% if e.rise %}
                  <li><strong>Rise:</strong> {{ e.rise|slice:":19" }}</li>
                  {% endif %}
                  {% if e.transit %}
                  <li><strong>Transit:</strong> {{ e.transit|slice:":19" }}</li>
                  {% endif %}
                  {% if e.set %}
                  <li><strong>Set:</strong> {{ e.set|slice:":19" }}</li>
                  {% endif %}
                  {% if e.obscuration %}
                    <li><strong>Obscuration:</strong> {{ e.obscuration }}</li>
                  {% endif %}
                </ul>

                <details class="mt-3">
                  <summary class="text-info">More Details</summary>
                  <pre class="bg-dark text-success p-2 rounded mt-2 small">{{ e.highlights|safe }}</pre>
                </details>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Loading Spinner -->
      <div id="loading-spinner" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading more events...</p>
      </div>

      <!-- End of Events Message -->
      <div id="end-message" class="alert alert-info text-center" style="display: none;">
        <i class="bi bi-check-circle"></i> All events loaded
      </div>

      <!-- Error Message -->
      <div id="error-message" class="alert alert-danger text-center" style="display: none;">
        <i class="bi bi-exclamation-triangle"></i> <span id="error-text">Failed to load events</span>
        <button class="btn btn-outline-danger btn-sm ms-2" onclick="retryLoad()">Retry</button>
      </div>
    {% else %}
      <div class="alert alert-warning text-center">
        No upcoming events found.
      </div>
    {% endif %}
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Infinite scroll implementation
    let currentOffset = {{ events|length }};
    let isLoading = false;
    let hasMore = {{ has_more|yesno:"true,false" }};
    let retryCount = 0;
    const maxRetries = 3;

    function createEventCard(event) {
      const peak = event.peak ? event.peak.slice(0, 19) : 'N/A';
      const rise = event.rise ? event.rise.slice(0, 19) : 'N/A';
      const transit = event.transit ? event.transit.slice(0, 19) : 'N/A';
      const set = event.set ? event.set.slice(0, 19) : 'N/A';
      
      return `
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card bg-secondary text-light shadow-lg h-100 position-relative">
            <div class="card-body">
              <div class="position-absolute top-0 end-0 p-2">
                <i class="bi bi-globe-asia-australia favorite-event-toggle"
                  data-event-id="${event.body}_${event.type}_${event.peak}"
                  data-body="${event.body}"
                  data-type="${event.type}"
                  data-peak="${event.peak || ''}"
                  data-rise="${event.rise || ''}"
                  data-transit="${event.transit || ''}"
                  data-set="${event.set || ''}"
                  style="font-size: 1.5rem; cursor: pointer; color: #0dcaf0;"></i>
              </div>
              <h5 class="card-title">${event.body.charAt(0).toUpperCase() + event.body.slice(1)}</h5>
              <h6 class="card-subtitle mb-2 text-warning">${event.type ? event.type.charAt(0).toUpperCase() + event.type.slice(1) : 'Rise-Set'}</h6>
              <ul class="list-unstyled mt-3 mb-4">
                ${event.peak ? `<li><strong>Peak/Transit:</strong> ${peak}</li>` : ''}
                ${event.rise ? `<li><strong>Rise:</strong> ${rise}</li>` : ''}
                ${event.transit ? `<li><strong>Transit:</strong> ${transit}</li>` : ''}
                ${event.set ? `<li><strong>Set:</strong> ${set}</li>` : ''}
                ${event.obscuration ? `<li><strong>Obscuration:</strong> ${event.obscuration}</li>` : ''}
              </ul>
              <details class="mt-3">
                <summary class="text-info">More Details</summary>
                <pre class="bg-dark text-success p-2 rounded mt-2 small">${JSON.stringify(event.highlights, null, 2)}</pre>
              </details>
            </div>
          </div>
        </div>
      `;
    }

    function showLoading() {
      document.getElementById('loading-spinner').style.display = 'block';
      document.getElementById('end-message').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading-spinner').style.display = 'none';
    }

    function showEndMessage() {
      document.getElementById('end-message').style.display = 'block';
      hideLoading();
    }

    function showError(message) {
      document.getElementById('error-text').textContent = message;
      document.getElementById('error-message').style.display = 'block';
      hideLoading();
    }

    function loadMoreEvents() {
      if (isLoading || !hasMore) return;

      isLoading = true;
      showLoading();

      fetch(`/api/events/?offset=${currentOffset}&limit=20`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.events && data.events.length > 0) {
            const container = document.getElementById('events-container');
            data.events.forEach(event => {
              container.insertAdjacentHTML('beforeend', createEventCard(event));
            });

            // Attach favorite listeners to new items
            initEventFavoriteButtons();

            currentOffset += data.events.length;
            hasMore = data.has_more;
            
            if (!hasMore) {
              showEndMessage();
            }
          } else {
            hasMore = false;
            showEndMessage();
          }
          retryCount = 0; // Reset retry count on success
        })
        .catch(error => {
          console.error('Error loading events:', error);
          if (retryCount < maxRetries) {
            retryCount++;
            setTimeout(() => {
              loadMoreEvents();
            }, 1000 * retryCount); // Exponential backoff
          } else {
            showError(`Failed to load events: ${error.message}`);
          }
        })
        .finally(() => {
          isLoading = false;
        });
    }

    function retryLoad() {
      retryCount = 0;
      loadMoreEvents();
    }

    // Debounced scroll handler
    let scrollTimeout;
    function handleScroll() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // Load more when user is 200px from bottom
        if (scrollTop + windowHeight >= documentHeight - 200) {
          loadMoreEvents();
        }
      }, 100);
    }

    // Initialize scroll listener
    window.addEventListener('scroll', handleScroll);

    // Load more events on page load if needed
    document.addEventListener('DOMContentLoaded', function() {
      if (hasMore && currentOffset < 20) {
        // If we have more events and haven't loaded the initial batch yet
        loadMoreEvents();
      }
    });
  </script>
  <script>
function initEventFavoriteButtons() {
  document.querySelectorAll(".favorite-event-toggle").forEach(icon => {
    icon.addEventListener("click", function (e) {
      e.stopPropagation();

      const iconEl = this;

      // Generate eventID 
      const eventId = `${iconEl.dataset.body}_${iconEl.dataset.type}_${iconEl.dataset.peak}`;

      console.log("=== EVENT FAVORITE TOGGLE ===");
      console.log("Body:", iconEl.dataset.body);
      console.log("Type:", iconEl.dataset.type);
      console.log("Peak:", iconEl.dataset.peak);
      console.log("Rise:", iconEl.dataset.rise);
      console.log("Transit:", iconEl.dataset.transit);
      console.log("Set:", iconEl.dataset.set);
      console.log("Generated eventId:", eventId);

      fetch("{% url 'toggle_event_favorite' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
          event_id: eventId,
          body: iconEl.dataset.body,
          type: iconEl.dataset.type,
          peak: iconEl.dataset.peak,
          rise: iconEl.dataset.rise,
          transit: iconEl.dataset.transit,
          set: iconEl.dataset.set
        })
      })
      .then(res => {
        console.log("Server response status:", res.status);
        return res.json();
      })
      .then(data => {
        console.log("Parsed server response:", data);

        if (data.redirect) {
          console.warn("User is NOT logged in. Redirecting...");
          window.location.href = data.redirect;
          return;
        }

        if (data.favorited) {
          iconEl.classList.add("text-warning");
          iconEl.classList.remove("text-info");
        } else {
          iconEl.classList.remove("text-warning");
          iconEl.classList.add("text-info");
        }
      })
      .catch(err => {
        console.error("ERROR toggling favorite:", err);
      });
    });
  });
}

// Init for initial page load
document.addEventListener("DOMContentLoaded", initEventFavoriteButtons);

  </script>
</body>
</html>