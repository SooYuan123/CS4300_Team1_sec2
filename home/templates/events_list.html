{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Astronomical Events</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body class="bg-dark text-light">
  <div class="container my-5">
    <h1 class="text-center mb-5" style="font-family: 'Orbitron', sans-serif;">
      Upcoming Astronomical Events
    </h1>

    {% if events %}
      <div class="row g-4" id="events-container">
        {% for e in events %}
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card bg-secondary text-light shadow-lg h-100">
              <div class="card-body">
                <h5 class="card-title">{{ e.body|title }}</h5>
                <h6 class="card-subtitle mb-2 text-warning">{{ e.type|title }}</h6>
                <ul class="list-unstyled mt-3 mb-4">
                  <li><strong>Peak:</strong> {{ e.peak }}</li>
                  <li><strong>Rise:</strong> {{ e.rise }}</li>
                  <li><strong>Set:</strong> {{ e.set }}</li>
                  {% if e.obscuration %}
                    <li><strong>Obscuration:</strong> {{ e.obscuration }}</li>
                  {% endif %}
                </ul>

                <details class="mt-3">
                  <summary class="text-info">More Details</summary>
                  <pre class="bg-dark text-success p-2 rounded mt-2 small">{{ e.highlights|json_script:"highlights" }}</pre>
                </details>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Loading Spinner -->
      <div id="loading-spinner" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading more events...</p>
      </div>

      <!-- End of Events Message -->
      <div id="end-message" class="alert alert-info text-center" style="display: none;">
        <i class="bi bi-check-circle"></i> All events loaded
      </div>

      <!-- Error Message -->
      <div id="error-message" class="alert alert-danger text-center" style="display: none;">
        <i class="bi bi-exclamation-triangle"></i> <span id="error-text">Failed to load events</span>
        <button class="btn btn-outline-danger btn-sm ms-2" onclick="retryLoad()">Retry</button>
      </div>
    {% else %}
      <div class="alert alert-warning text-center">
        No upcoming events found.
      </div>
    {% endif %}
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Infinite scroll implementation
    let currentOffset = {{ events|length }};
    let isLoading = false;
    let hasMore = {{ has_more|yesno:"true,false" }};
    let retryCount = 0;
    const maxRetries = 3;

    function createEventCard(event) {
      return `
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card bg-secondary text-light shadow-lg h-100">
            <div class="card-body">
              <h5 class="card-title">${event.body.charAt(0).toUpperCase() + event.body.slice(1)}</h5>
              <h6 class="card-subtitle mb-2 text-warning">${event.type ? event.type.charAt(0).toUpperCase() + event.type.slice(1) : 'N/A'}</h6>
              <ul class="list-unstyled mt-3 mb-4">
                <li><strong>Peak:</strong> ${event.peak || 'N/A'}</li>
                <li><strong>Rise:</strong> ${event.rise || 'N/A'}</li>
                <li><strong>Set:</strong> ${event.set || 'N/A'}</li>
                ${event.obscuration ? `<li><strong>Obscuration:</strong> ${event.obscuration}</li>` : ''}
              </ul>
              <details class="mt-3">
                <summary class="text-info">More Details</summary>
                <pre class="bg-dark text-success p-2 rounded mt-2 small">${JSON.stringify(event.highlights, null, 2)}</pre>
              </details>
            </div>
          </div>
        </div>
      `;
    }

    function showLoading() {
      document.getElementById('loading-spinner').style.display = 'block';
      document.getElementById('end-message').style.display = 'none';
      document.getElementById('error-message').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading-spinner').style.display = 'none';
    }

    function showEndMessage() {
      document.getElementById('end-message').style.display = 'block';
      hideLoading();
    }

    function showError(message) {
      document.getElementById('error-text').textContent = message;
      document.getElementById('error-message').style.display = 'block';
      hideLoading();
    }

    function loadMoreEvents() {
      if (isLoading || !hasMore) return;

      isLoading = true;
      showLoading();

      fetch(`/api/events/?offset=${currentOffset}&limit=20`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.events && data.events.length > 0) {
            const container = document.getElementById('events-container');
            data.events.forEach(event => {
              container.insertAdjacentHTML('beforeend', createEventCard(event));
            });
            currentOffset += data.events.length;
            hasMore = data.has_more;
            
            if (!hasMore) {
              showEndMessage();
            }
          } else {
            hasMore = false;
            showEndMessage();
          }
          retryCount = 0; // Reset retry count on success
        })
        .catch(error => {
          console.error('Error loading events:', error);
          if (retryCount < maxRetries) {
            retryCount++;
            setTimeout(() => {
              loadMoreEvents();
            }, 1000 * retryCount); // Exponential backoff
          } else {
            showError(`Failed to load events: ${error.message}`);
          }
        })
        .finally(() => {
          isLoading = false;
        });
    }

    function retryLoad() {
      retryCount = 0;
      loadMoreEvents();
    }

    // Debounced scroll handler
    let scrollTimeout;
    function handleScroll() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // Load more when user is 200px from bottom
        if (scrollTop + windowHeight >= documentHeight - 200) {
          loadMoreEvents();
        }
      }, 100);
    }

    // Initialize scroll listener
    window.addEventListener('scroll', handleScroll);

    // Load more events on page load if needed
    document.addEventListener('DOMContentLoaded', function() {
      if (hasMore && currentOffset < 20) {
        // If we have more events and haven't loaded the initial batch yet
        loadMoreEvents();
      }
    });
  </script>
</body>
</html>
