{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Astronomical Events</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

{% include 'header.html' %}
<body class="bg-dark text-light">
  <div class="container my-5">
    <h1 class="text-center mb-5 text-glow" style="font-family: 'Orbitron', sans-serif; font-size: 3.5rem;">Astronomical Events & Data</h1>

    {% if moon_phase %}
    <div class="mb-5">
      <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
        <i class="bi bi-moon-stars"></i> Current Moon Phase
      </h3>
      <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
          <div class="card bg-dark border-warning text-light shadow">
            <div class="card-body text-center">
              <h4 class="text-warning mb-3">Moon Status</h4>
              {% if moon_phase.illumination %}
              <p class="mb-2"><strong>Illumination:</strong> {{ moon_phase.illumination|floatformat:1 }}%</p>
              {% endif %}
              {% if moon_phase.phase %}
              <p class="mb-2"><strong>Phase:</strong> {{ moon_phase.phase }}</p>
              {% endif %}
              {% if moon_phase.age %}
              <p class="mb-0"><strong>Age:</strong> {{ moon_phase.age|floatformat:1 }} days</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <hr class="my-5 border-secondary">
    {% endif %}

    {% if solar_eclipses %}
    <div class="mb-5">
      <h3 class="text-center mb-4" style="font-family: 'Orbitron', sans-serif;">
        <i class="bi bi-brightness-high"></i> Upcoming Solar Eclipses
      </h3>
      <div class="row g-3">
        {% for eclipse in solar_eclipses %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card bg-dark border-danger text-light shadow">
            <div class="card-body">
              <h5 class="card-title text-danger">
                <i class="bi bi-exclamation-triangle"></i> Solar Eclipse
              </h5>
              <ul class="list-unstyled mt-3">
                {% if eclipse.date %}
                <li><strong>Date:</strong> {{ eclipse.date }}</li>
                {% endif %}
                {% if eclipse.type %}
                <li><strong>Type:</strong> {{ eclipse.type }}</li>
                {% endif %}
                {% if eclipse.magnitude %}
                <li><strong>Magnitude:</strong> {{ eclipse.magnitude }}</li>
                {% endif %}
              </ul>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <hr class="my-5 border-secondary">
    {% endif %}

    <div class="mb-5 text-center">
      <div class="position-relative mx-auto" style="max-width: 380px; width: 100%;">
        <input id="city-search" type="text" class="form-control space-input" placeholder="ðŸ”­ Search for a city...">
        <div id="search-results" class="list-group position-absolute w-100 shadow-lg" style="z-index: 999; display:none;"></div>
      </div>
    </div>

    <div class="mb-5">
      <h1 class="text-center mb-5 text-glow" style="font-family: 'Orbitron', sans-serif; font-size: 3.5rem;"><i class="bi bi-stars"></i> Celestial Bodies</h1>
      <p class="text-center mb-4" style="color: #d2af26; text-shadow: 0 0 6px #171819;">
        <i class="bi bi-geo-alt"></i> Event Visibility Times for
        <span id="location-name">{{ location }}</span>
      </p>

      <div id="celestial-container" class="row g-3 text-center"></div>
      <div id="celestial-loading" class="text-center my-3" style="display:none;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 mb-0">Loading celestial data...</p>
      </div>
    </div>

    <hr class="my-5 border-secondary">

    <h1 class="text-center mb-5 text-glow" style="font-family: 'Orbitron', sans-serif; font-size: 3.5rem;"><i class="bi bi-calendar-event"></i> Sun & Moon Rise/Set Times</h1>
    <p class="text-center mb-4" style="color: #d2af26; text-shadow: 0 0 6px #171819;">
      <i class="bi bi-info-circle"></i> Powered by Radiant Drift API
    </p>

    <div id="events-container" class="row g-4"></div>

    <div id="loading-spinner" class="text-center my-4" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Loading more events...</p>
    </div>

    <div id="end-message" class="alert alert-info text-center" style="display: none;"><i class="bi bi-check-circle"></i> All events loaded</div>

    <div id="error-message" class="alert alert-danger text-center" style="display: none;">
      <i class="bi bi-exclamation-triangle"></i> <span id="error-text">Failed to load events</span>
      <button class="btn btn-outline-danger btn-sm ms-2" onclick="retryLoad()">Retry</button>
    </div>

    <hr class="my-5 border-secondary">

    <h1 class="text-center mb-5 text-glow" style="font-family: 'Orbitron', sans-serif; font-size: 3.5rem;">
      <i class="bi bi-activity"></i> Aurora Forecast
    </h1>
    <p class="text-center mb-4" style="color: #d2af26; text-shadow: 0 0 6px #171819;">
      <i class="bi bi-info-circle"></i> Real-time Geomagnetic Activity (Kp Index) by NOAA
    </p>

    <div class="row justify-content-center mb-5">
      <div class="col-md-6 col-lg-4">
        <div class="card bg-dark border-secondary shadow-lg">
          <div class="card-body text-center" id="aurora-container">
            <div class="spinner-border text-info" role="status"></div>
            <p class="mt-2">Checking solar activity...</p>
          </div>
          <div class="card-footer bg-transparent border-secondary">
             <p id="aurora-explanation" class="small text-light mb-0">
               Loading impact data...
             </p>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-5 border-secondary">

    <div class="mb-5 pb-5">
      <h1 class="text-center mb-5 text-glow" style="font-family: 'Orbitron', sans-serif; font-size: 3.5rem;">
        <i class="bi bi-cloud-sun"></i> Weather Forecast
      </h1>

      <div id="weather-loading" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-info" role="status"></div>
        <p class="mt-2">Forecasting viewing conditions...</p>
      </div>

      <div id="weather-container" class="card bg-dark border-info shadow-lg" style="display:none;">
        <div class="card-header bg-transparent border-info p-3">
            <h4 class="text-info mb-0 text-center">Viewing Conditions (Next 12 Hours)</h4>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-dark table-hover text-center mb-0 align-middle">
              <thead>
                <tr class="text-info" style="font-size: 1.2rem;">
                  <th class="py-4">Time</th>
                  <th class="py-4">Cloud Cover</th>
                  <th class="py-4">Visibility</th>
                  <th class="py-4">Precipitation</th>
                  <th class="py-4">Status</th>
                </tr>
              </thead>
              <tbody id="weather-table-body">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* === CONFIG / STATE === */
    let selectedLat = "38.8339";
    let selectedLon = "-104.8214";
    let selectedLocationName = "Colorado Springs, CO";

    let offset = 0;
    const limit = 20;
    let isLoading = false;
    let hasMore = true;
    let retryCount = 0;
    const maxRetries = 3;

    function $(id){ return document.getElementById(id); }

    /* === RENDER HELPERS === */
    function renderBodyCard(body){
      return `
      <div class="col-12 col-md-6 col-lg-4 col-xl-3">
        <div class="card bg-dark border-primary text-light shadow h-100">
          <div class="card-body">
            <h5 class="card-title text-primary"><i class="bi bi-circle-fill"></i> ${body.name}</h5>
            ${body.nextVisibleStr ? `<div class="alert alert-info py-2 mb-3"><small><strong>Next Visible:</strong><br>${body.nextVisibleStr.slice(0,10)} ${body.nextVisibleStr.slice(11,16)} UTC</small></div>` : `<div class="alert alert-secondary py-2 mb-3"><small>Visibility data unavailable.</small></div>`}
            <details class="mt-2"><summary class="text-warning" style="cursor:pointer;">Physical Properties</summary>
              <ul class="list-unstyled mt-2 small">
                ${body.meanRadius ? `<li><strong>Radius:</strong> ${body.meanRadius.toFixed(0)} km</li>` : ""}
                ${body.mass?.massValue ? `<li><strong>Mass:</strong> ${body.mass.massValue} Ã— 10^${body.mass.massExponent} kg</li>` : ""}
                ${body.density ? `<li><strong>Density:</strong> ${body.density.toFixed(2)} g/cmÂ³</li>` : ""}
                ${body.gravity ? `<li><strong>Gravity:</strong> ${body.gravity.toFixed(2)} m/sÂ²</li>` : ""}
                ${body.avgTemp ? `<li><strong>Avg Temp:</strong> ${body.avgTemp} K</li>` : ""}
              </ul>
            </details>
            ${body.moons?.length ? `<details class="mt-2"><summary class="text-info">Moons (${body.moons.length})</summary><div class="mt-2 small" style="max-height:100px; overflow-y:auto;">${body.moons.map(m => `<span class="badge bg-secondary me-1 mb-1">${m.moon || m.name || ''}</span>`).join("")}</div></details>` : ""}
          </div>
        </div>
      </div>`;
    }

    function createEventCard(event){
      const peak = event.peak ? event.peak.slice(0,19) : 'N/A';
      const rise = event.rise ? event.rise.slice(0,19) : 'N/A';
      const transit = event.transit ? event.transit.slice(0,19) : 'N/A';
      const set = event.set ? event.set.slice(0,19) : 'N/A';
      const eventId = (event.body + '_' + event.type + '_' + (event.peak || '')).replaceAll(' ', '_');
      const detailUrl = `/event/detail/?body=${encodeURIComponent(event.body)}&type=${encodeURIComponent(event.type)}&date=${encodeURIComponent(peak)}`;

      return `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card bg-secondary text-light shadow-lg h-100">
          <div class="position-absolute top-0 end-0 p-2">
            <i class="bi bi-globe-asia-australia favorite-event-toggle text-info" data-event-id="${eventId}"
               data-body="${event.body}" data-type="${event.type}"
               data-peak="${event.peak || ''}" data-rise="${event.rise || ''}"
               data-transit="${event.transit || ''}" data-set="${event.set || ''}"
               style="cursor:pointer; font-size:1.4rem;"></i>
          </div>
          <div class="card-body">
            <h5 class="card-title">${event.body}</h5>
            <h6 class="card-subtitle mb-2 text-warning">${event.type}</h6>
            <ul class="list-unstyled mt-3 mb-4">
              ${event.peak ? `<li><strong>Peak/Transit:</strong> ${peak}</li>` : ''}
              ${event.rise ? `<li><strong>Rise:</strong> ${rise}</li>` : ''}
              ${event.transit ? `<li><strong>Transit:</strong> ${transit}</li>` : ''}
              ${event.set ? `<li><strong>Set:</strong> ${set}</li>` : ''}
              ${event.obscuration ? `<li><strong>Obscuration:</strong> ${event.obscuration}</li>` : ''}
            </ul>
          </div>
          <div class="card-footer bg-transparent border-0 pt-0">
             <a href="${detailUrl}" class="btn btn-sm btn-info w-100 text-dark fw-bold">
                 <i class="bi bi-robot"></i> View AI Analysis
             </a>
          </div>
        </div>
      </div>`;
    }

    function createWeatherRow(hour) {
        // Logic for viewing status
        let statusHtml = '';
        if (hour.cloud_cover < 20) {
            statusHtml = `<div class="text-success"><i class="bi bi-stars" style="font-size: 1.3rem;"></i> <span class="fw-bold ms-2">Great</span></div>`;
        } else if (hour.cloud_cover < 60) {
            statusHtml = `<div class="text-warning"><i class="bi bi-cloud-moon" style="font-size: 1.3rem;"></i> <span class="fw-bold ms-2">Fair</span></div>`;
        } else {
            statusHtml = `<div class="text-danger"><i class="bi bi-clouds" style="font-size: 1.3rem;"></i> <span class="fw-bold ms-2">Poor</span></div>`;
        }

        // Logic for Progress Bar Color
        let barClass = 'bg-danger'; // Default to Red (Poor) for high cloud cover
        if (hour.cloud_cover < 20) barClass = 'bg-success';
        else if (hour.cloud_cover < 50) barClass = 'bg-warning';

        // Logic for Precipitation
        let precipHtml = `<span class="text-light"><i class="bi bi-droplet"></i> 0%</span>`;
        if (hour.precipitation_probability > 0) {
            precipHtml = `<span class="text-info fw-bold"><i class="bi bi-droplet-fill"></i> ${hour.precipitation_probability}%</span>`;
        }

        return `
        <tr>
            <td class="fs-5">${hour.time.slice(11,16)}</td>
            <td style="min-width: 150px;">
                <div class="d-flex align-items-center justify-content-center">
                    <span class="me-2" style="width: 40px;">${hour.cloud_cover}%</span>
                    <div class="progress flex-grow-1" style="height: 10px; background-color: rgba(255,255,255,0.1);">
                        <div class="progress-bar ${barClass}" role="progressbar" style="width: ${hour.cloud_cover}%"></div>
                    </div>
                </div>
            </td>
            <td class="text-light">
                <span class="badge bg-transparent border border-light">${Math.round(hour.visibility)} m</span>
            </td>
            <td>${precipHtml}</td>
            <td>${statusHtml}</td>
        </tr>`;
    }

    /* === DATA LOADERS === */
    function loadCelestialBodies(){
      const container = $('celestial-container');
      const loader = $('celestial-loading');
      container.innerHTML = '';
      loader.style.display = 'block';

      fetch(`/api/celestial-bodies/?lat=${encodeURIComponent(selectedLat)}&lon=${encodeURIComponent(selectedLon)}`)
        .then(r => r.json())
        .then(data => {
          loader.style.display = 'none';
          const bodies = data.bodies || [];
          bodies.forEach(b => container.insertAdjacentHTML('beforeend', renderBodyCard(b)));
        })
        .catch(err => {
          loader.style.display = 'none';
          console.error('Failed fetching celestial bodies', err);
        });
    }

    function loadWeatherForecast() {
        const container = $('weather-container');
        const tbody = $('weather-table-body');
        const loader = $('weather-loading');

        container.style.display = 'none';
        tbody.innerHTML = '';
        loader.style.display = 'block';

        fetch(`/api/weather/?lat=${encodeURIComponent(selectedLat)}&lon=${encodeURIComponent(selectedLon)}`)
            .then(r => r.json())
            .then(data => {
                loader.style.display = 'none';
                const forecast = data.forecast || [];
                if (forecast.length > 0) {
                    forecast.forEach(h => tbody.insertAdjacentHTML('beforeend', createWeatherRow(h)));
                    container.style.display = 'block';
                }
            })
            .catch(err => {
                loader.style.display = 'none';
                console.error('Failed fetching weather', err);
            });
    }

    function renderEvents(events) {
      const container = $('events-container');
      events.forEach(event => {
        container.insertAdjacentHTML("beforeend", createEventCard(event));
      });
    }

    function loadMoreEvents(){
      if (isLoading || !hasMore) return;
      isLoading = true;
      $('loading-spinner').style.display = 'block';
      $('error-message').style.display = 'none';

      fetch(`/api/events/?offset=${offset}&limit=${limit}&lat=${encodeURIComponent(selectedLat)}&lon=${encodeURIComponent(selectedLon)}`)
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        })
        .then(data => {
          const events = data.events || [];
          if (!events.length) {
            hasMore = false;
            $('end-message').style.display = 'block';
            return;
          }
          renderEvents(events);
          offset += events.length;
          hasMore = !!data.has_more;
        })
        .catch(err => {
          console.error('Error loading events', err);
          retryCount++;
          if (retryCount <= maxRetries) {
            setTimeout(loadMoreEvents, 1000 * retryCount);
          } else {
            $('error-text').textContent = `Failed to load events: ${err.message}`;
            $('error-message').style.display = 'block';
          }
        })
        .finally(() => {
          isLoading = false;
          $('loading-spinner').style.display = 'none';
        });
    }

    function retryLoad(){ retryCount = 0; loadMoreEvents(); }

    function loadAurora() {
      // 1. Definition of Kp Impacts
      function getKpExplanation(kp) {
        if (kp >= 6) return "<strong>EXTREME STORM:</strong> Visible as far south as Utah/Colorado. Photography excellent.";
        if (kp >= 5) return "<strong>STORM LEVEL:</strong> Aurora likely in northern states (WA, MI, NY). Good visibility.";
        if (kp >= 4) return "<strong>ACTIVE:</strong> Visible in Canada and Alaska. Faint glow possible on northern horizon in US.";
        if (kp >= 3) return "<strong>UNSETTLED:</strong> Visible only in high latitudes. minimal chance in US.";
        return "<strong>QUIET:</strong> No significant activity. Aurora only visible in the Arctic circle.";
      }

      fetch('/api/aurora/')
        .then(r => r.json())
        .then(data => {
          const container = document.getElementById('aurora-container');
          const explanation = document.getElementById('aurora-explanation');

          if (data.error) {
             container.innerHTML = '<p class="text-light">Data Unavailable</p>';
             explanation.textContent = "Could not connect to NOAA.";
             return;
          }

          const percentage = (data.kp_index / 9) * 100;
          const explainText = getKpExplanation(data.kp_index);

          container.innerHTML = `
            <h1 class="display-4 fw-bold text-${data.color}">${data.kp_index}</h1>
            <p class="lead text-light">Status: <span class="text-${data.color} fw-bold">${data.status}</span></p>
            <div class="progress bg-secondary" style="height: 10px;">
              <div class="progress-bar bg-${data.color}" role="progressbar" style="width: ${percentage}%"></div>
            </div>
            <small class="text-light mt-2 d-block">Updated: ${data.timestamp.slice(11,16)} UTC</small>
          `;

          // 2. Inject the explanation
          explanation.innerHTML = explainText;
        })
        .catch(err => console.error('Aurora error:', err));
    }

    window.addEventListener('scroll', () => {
      if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 200)) {
        loadMoreEvents();
      }
    });

    /* === AUTOCOMPLETE (city search) === */
    let cityTimer = null;
    const searchInput = $('city-search');
    const resultsBox = $('search-results');

    searchInput.addEventListener('input', function(){
      const q = this.value.trim();
      if (q.length < 2) { resultsBox.style.display = 'none'; return; }
      clearTimeout(cityTimer);
      cityTimer = setTimeout(() => {
        fetch(`/api/search-city/?q=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(data => {
            resultsBox.innerHTML = '';
            const results = data.results || [];
            if (!results.length) { resultsBox.style.display = 'none'; return; }
            results.forEach(item => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'list-group-item list-group-item-action';
              btn.textContent = item.name;
              btn.addEventListener('click', () => {
                // UPDATE STATE
                searchInput.value = item.name;
                selectedLat = item.lat;
                selectedLon = item.lon;
                selectedLocationName = item.name;
                $('location-name').textContent = item.name.split(',')[0] || item.name;
                resultsBox.style.display = 'none';

                // RESET AND RELOAD ALL SECTIONS
                offset = 0;
                hasMore = true;
                $('events-container').innerHTML = '';

                loadCelestialBodies();
                loadMoreEvents();
                loadWeatherForecast(); // <--- This now updates dynamically!
              });
              resultsBox.appendChild(btn);
            });
            resultsBox.style.display = 'block';
          })
          .catch(err => { console.error('Search error', err); resultsBox.style.display = 'none'; });
      }, 300);
    });

    document.addEventListener('click', (e) => { if (!e.target.closest('#search-results') && e.target !== searchInput) resultsBox.style.display = 'none'; });

    // Favorite button handler
    document.addEventListener('click', function(e){
      const el = e.target.closest('.favorite-event-toggle');
      if (!el) return;
      e.stopPropagation();

      const params = new URLSearchParams({
        event_id: el.dataset.eventId || `${el.dataset.body}_${el.dataset.type}_${el.dataset.peak}`,
        body: el.dataset.body || '',
        type: el.dataset.type || '',
        peak: el.dataset.peak || '',
        rise: el.dataset.rise || '',
        transit: el.dataset.transit || '',
        set: el.dataset.set || ''
      });

      fetch("{% url 'toggle_event_favorite' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params.toString()
      })
      .then(r => r.json())
      .then(data => {
        if (data.redirect) { window.location.href = data.redirect; return; }
        if (data.favorited) {
          el.classList.remove('text-info'); el.classList.add('text-warning');
        } else {
          el.classList.remove('text-warning'); el.classList.add('text-info');
        }
      })
      .catch(err => console.error('Favorite toggle error', err));
    });

    /* === INITIAL LOAD === */
    document.addEventListener("DOMContentLoaded", () => {
    loadCelestialBodies()
    loadMoreEvents()
    loadWeatherForecast()
    loadAurora()
})
;
  </script>

</body>
</html>