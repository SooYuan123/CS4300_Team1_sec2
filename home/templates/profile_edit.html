{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile - CelestiaTrack</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

{% include 'header.html' %}

<body>
  <div class="hero">
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card bg-dark text-light border-info">
            <div class="card-header bg-transparent border-info">
              <h3 class="text-glow">Edit Profile</h3>
            </div>
            <div class="card-body">
              <!-- Display messages -->
              {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
              {% endif %}

              <!-- Profile Edit Form -->
              <form method="POST">
                {% csrf_token %}

                <!-- User Information -->
                <fieldset class="mb-4">
                  <legend class="border-bottom border-info mb-3 pb-2 text-glow">User Information</legend>

                  <div class="mb-3">
                    <label for="{{ user_form.username.id_for_label }}" class="form-label">Username</label>
                    {{ user_form.username }}
                    {% if user_form.username.errors %}
                      <div class="text-danger">{{ user_form.username.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="mb-3">
                    <label for="{{ user_form.email.id_for_label }}" class="form-label">Email</label>
                    {{ user_form.email }}
                    {% if user_form.email.errors %}
                      <div class="text-danger">{{ user_form.email.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="{{ user_form.first_name.id_for_label }}" class="form-label">First Name</label>
                        {{ user_form.first_name }}
                        {% if user_form.first_name.errors %}
                          <div class="text-danger">{{ user_form.first_name.errors }}</div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="{{ user_form.last_name.id_for_label }}" class="form-label">Last Name</label>
                        {{ user_form.last_name }}
                        {% if user_form.last_name.errors %}
                          <div class="text-danger">{{ user_form.last_name.errors }}</div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </fieldset>

                <!-- Profile Information -->
                <fieldset class="mb-4">
                  <legend class="border-bottom border-info mb-3 pb-2 text-glow">Profile Information</legend>

                  <!-- Profile Picture Upload -->
                  <div class="mb-4">
                    <label class="form-label">Profile Picture</label>
                    <div class="d-flex align-items-center gap-3 mb-2">
                      <div>
                        <img id="profile-picture-preview" 
                             src="{{ user.profile.get_profile_picture_url }}" 
                             alt="Profile picture preview"
                             style="width: 150px; height: 150px; object-fit: cover; border: 2px solid #00d4ff; border-radius: 10px;">
                      </div>
                      <div class="flex-grow-1">
                        <button type="button" class="btn btn-outline-info" id="upload-picture-btn">
                          <i class="fas fa-upload"></i> Upload New Picture
                        </button>
                        <input type="file" id="id_profile_picture_input" accept="image/*" style="display: none;">
                        <small class="form-text text-muted d-block mt-2">
                          Minimum size: 200x200px. Image will be cropped to square.
                        </small>
                      </div>
                    </div>
                    {% if profile_form.profile_picture.errors %}
                      <div class="text-danger">{{ profile_form.profile_picture.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="mb-3">
                    <label for="{{ profile_form.bio.id_for_label }}" class="form-label">Bio</label>
                    {{ profile_form.bio }}
                    {% if profile_form.bio.errors %}
                      <div class="text-danger">{{ profile_form.bio.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="mb-3">
                    <label for="{{ profile_form.location.id_for_label }}" class="form-label">Location</label>
                    {{ profile_form.location }}
                    {% if profile_form.location.errors %}
                      <div class="text-danger">{{ profile_form.location.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="mb-3">
                    <label for="{{ profile_form.favorite_celestial_body.id_for_label }}" class="form-label">Favorite Celestial Objects</label>
                    {{ profile_form.favorite_celestial_body }}
                    {% if profile_form.favorite_celestial_body.errors %}
                      <div class="text-danger">{{ profile_form.favorite_celestial_body.errors }}</div>
                    {% endif %}
                    <small class="form-text text-muted d-block mt-1">
                      Separate multiple objects with commas (e.g., Mars, Jupiter, Andromeda Galaxy)
                    </small>
                  </div>
                </fieldset>

                <!-- Buttons -->
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-glow">
                    <i class="fas fa-save"></i> Save Changes
                  </button>
                  <a href="{% url 'profile' username=user.username %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>CelestiaTrack - Guided by the light of discovery.</p>
  </footer>

  <!-- Profile Picture Crop Modal -->
  <div class="modal fade" id="cropImageModal" tabindex="-1" aria-labelledby="cropImageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-info">
        <div class="modal-header border-info">
          <h5 class="modal-title text-glow" id="cropImageModalLabel">Crop Profile Picture</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="img-container" style="max-width: 100%; max-height: 500px; overflow: hidden;">
            <img id="imageToCrop" src="" alt="Crop me" style="max-width: 100%;">
          </div>
          <small class="text-muted d-block mt-2">Minimum size: 200x200px. Image will be cropped to square.</small>
        </div>
        <div class="modal-footer border-info">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-glow" id="cropAndUploadBtn">
            <i class="fas fa-check"></i> Crop & Upload
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Cropper.js JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>

  <script>
    let cropper;
    let cropModal;
    const uploadPictureBtn = document.getElementById('upload-picture-btn');
    const profilePictureInput = document.getElementById('id_profile_picture_input');
    const profilePicturePreview = document.getElementById('profile-picture-preview');
    const imageToCrop = document.getElementById('imageToCrop');
    const cropAndUploadBtn = document.getElementById('cropAndUploadBtn');

    // Open file input when clicking upload button
    if (uploadPictureBtn) {
      uploadPictureBtn.addEventListener('click', () => {
        profilePictureInput.click();
      });
    }

    // Handle file selection
    if (profilePictureInput) {
      profilePictureInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file.');
            return;
          }

          // Validate file size (max 10MB)
          if (file.size > 10 * 1024 * 1024) {
            alert('Image size must be less than 10MB.');
            return;
          }

          const reader = new FileReader();
          reader.onload = function(event) {
            imageToCrop.src = event.target.result;
            cropModal = new bootstrap.Modal(document.getElementById('cropImageModal'));
            cropModal.show();
            
            // Initialize cropper after modal is shown
            setTimeout(() => {
              if (cropper) {
                cropper.destroy();
              }
              cropper = new Cropper(imageToCrop, {
                aspectRatio: 1, // Square
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.8,
                restore: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
                minCropBoxWidth: 200,
                minCropBoxHeight: 200,
              });
            }, 300);
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Handle crop and upload
    if (cropAndUploadBtn) {
      cropAndUploadBtn.addEventListener('click', function() {
        if (!cropper) {
          alert('Please wait for the image to load.');
          return;
        }

        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
          width: 400,
          height: 400,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });

        if (!canvas) {
          alert('Error creating cropped image.');
          return;
        }

        // Convert canvas to blob
        canvas.toBlob(function(blob) {
          if (!blob) {
            alert('Error processing image.');
            return;
          }

          // Convert blob to base64
          const reader = new FileReader();
          reader.onload = function() {
            const base64data = reader.result;

            // Show loading state
            cropAndUploadBtn.disabled = true;
            cropAndUploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            // Upload to server
            const formData = new FormData();
            formData.append('cropped_image', base64data);

            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch('{% url "upload_profile_picture" %}', {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrftoken
              },
              body: formData
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Update preview
                profilePicturePreview.src = data.image_url + '?t=' + new Date().getTime();
                cropModal.hide();
                
                // Reset file input
                profilePictureInput.value = '';
                
                // Show success message
                alert('Profile picture updated successfully!');
              } else {
                alert('Error: ' + (data.error || 'Failed to upload image.'));
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('An error occurred while uploading the image.');
            })
            .finally(() => {
              cropAndUploadBtn.disabled = false;
              cropAndUploadBtn.innerHTML = '<i class="fas fa-check"></i> Crop & Upload';
            });
          };
          reader.readAsDataURL(blob);
        }, 'image/jpeg', 0.9);
      });
    }

    // Clean up cropper when modal is hidden
    const cropModalElement = document.getElementById('cropImageModal');
    if (cropModalElement) {
      cropModalElement.addEventListener('hidden.bs.modal', function() {
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        imageToCrop.src = '';
        profilePictureInput.value = '';
      });
    }
  </script>
</body>
</html>