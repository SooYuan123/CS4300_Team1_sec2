ai-code-review:
  name: ai-code-review
    runs-on: ubuntu-latest
    needs: [test-and-coverage]
    # Run on PRs that target main only; do not allow skipping by event type
    if: github.event_name == 'pull_request' && github.base_ref == 'main'

  permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure OpenAI credentials exist
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY is not set; failing ai-code-review."
            exit 1
          fi

      - name: Determine changed files vs base
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Code Review with ChatGPT (never skip)
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o-mini' }}
        with:
          script: |
            const { execSync } = require('child_process');
            const fetch = global.fetch;
            const allFiles = `\n${{ steps.changed-files.outputs.files }}`.trim().split('\n').filter(Boolean);
            const CODE_EXT = /\.(py|js|jsx|ts|tsx|css|scss|html|json|ya?ml|md)$/i;
            const codeFiles = allFiles.filter(f => CODE_EXT.test(f));

            // Build diff content (fall back to PR title/description if no code files)
            let diffContent = '';
            if (codeFiles.length > 0) {
              const PER_FILE_MAX_LINES = 300;
              const diffs = [];
              for (const file of codeFiles) {
                try {
                  const raw = execSync(`git diff origin/${{ github.base_ref }}...HEAD -- ${file}`, {encoding: 'utf8'});
                  if (!raw.trim()) continue;
                  const lines = raw.split('\n');
                  const head = lines.slice(0, PER_FILE_MAX_LINES).join('\n');
                  diffs.push(`### File: ${file}\n${head}${lines.length > PER_FILE_MAX_LINES ? '\n... (truncated)' : ''}`);
                } catch {}
              }
              diffContent = diffs.join('\n\n');
            }

            // If nothing code-like changed, still produce a review (do not skip the job)
            if (!diffContent) {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              const meta = `PR Title: ${pr.data.title}\n\nPR Body:\n${pr.data.body || '(no description)'}\n\nChanged files:\n${allFiles.join('\n') || '(none)'}`;
              diffContent = `No code files matched filter; review PR context instead:\n\n${meta}`;
            }

            async function chat(messages, maxTokens=1200, temperature=0.2) {
              const model = process.env.OPENAI_MODEL || 'gpt-4o-mini';
              const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                },
                body: JSON.stringify({ model, messages, max_tokens: maxTokens, temperature }),
              });
              const data = await resp.json();
              if (!resp.ok) {
                console.error('OpenAI API error:', data);
                throw new Error(`OpenAI API failed: ${data.error?.message || 'Unknown error'}`);
              }
              return data.choices[0].message.content;
            }

            const systemPrompt =
              'You are an expert code reviewer. Provide concise, actionable feedback on: ' +
              '1) Potential bugs, 2) Security issues, 3) Performance concerns, 4) Code quality/best practices, 5) Test coverage suggestions. ' +
              'Use bullets and reference files/lines when possible. Keep it succinct but specific.';

            // Cap prompt size
            const MAX_CHARS = 20000;
            if (diffContent.length > MAX_CHARS) {
              diffContent = diffContent.slice(-MAX_CHARS);
            }

            let reviewText = await chat([
              { role: 'system', content: systemPrompt },
              { role: 'user', content: `Review these changes (or PR context if no diff):\n${diffContent}` },
            ]);

            // Post a PR comment — existence of this comment is what you’ll require in branch protection (via status check pass)
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## AI Code Review\n\n${reviewText}\n\n---\n*Automated review*`
            });
